<?php 

/**
 * Aleph
 *
 * A simple PHP framework for very small sites.
 *
 * @package aleph
 * @author lastguest@gmail.com
 * @url https://github.com/lastguest/aleph
 * @version 1.0.0
 * @copyright Stefano Azzolini - 2014 - http://dreamnoctis.com
 */

function service($A,$B=null){static$C=array();if(is_null($B)){if(isset($C[$A])){return$C[$A]instanceof Closure?$C[$A]():$C[$A];}}else{$C[$A]=$B;}}function options($D=null,$B=null){static$E=array();if(is_null($D))return$E;if(is_null($B)){return isset($E[$D])?$E[$D]:null;}else{return$E[$D]=is_callable($B)?call_user_func($B):$B;}}function request(){$F=array();$G=rtrim(parse_url(filter_input(5,'REQUEST_URI'),5),'/')?:'/';if($H=trim(options('app.baseuri'),'/'))$G=preg_replace("~^/$H~",'',$G)?:'/';foreach($_SERVER as$I=>$J){if(substr($I,0,5)=='HTTP_')$F[str_replace('_','-',(substr($I,5)))]=$J;}$a=strtolower(filter_input(5,'REQUEST_METHOD'));return array('method'=>$a,'uri'=>filter('request.uri',$G),'query'=>filter_input_array(1),'post'=>filter_input_array(0),'cookies'=>filter_input_array(2),'headers'=>$F,);}function quit($b=500){if(function_exists('http_response_code')){http_response_code($b);}else{header("Status:$b",true,$b);}exit;}function response(){static$F=array(),$c=array();$d=func_get_args();$e=count($d)?strtolower(array_shift($d)):null;if(is_null($e)){return array('headers'=>array_values($F),'body'=>implode('',$c),);}else{switch($e){case 'header':$F[$d[0]]="{$d[0]}:{$d[1]}";break;case 'delete':$F=$c=array();break;case 'clear':case 'clean':$c=array();break;case 'append':$c[]=$d[0];break;case 'start':ob_start();break;case 'stop':if(ob_get_level()>1){$c[]=ob_get_contents();ob_end_clean();}break;case 'append':$c[]=$d[0];break;}}}function event($e,$f,$g){static$h=array();switch(strtolower($e)){case 'on':$h[$f][]=$g;break;case 'off':if($g){unset($h[$f][$g]);}else{unset($h[$f]);}break;case 'trigger':if(isset($h[$f])&&isset($h[$f])){if(!is_array($g))$g=array();foreach($h[$f]as$i)call_user_func_array($i,$g);}break;}}function email($j,$k,$l,$m){$n=$_SERVER['REQUEST_TIME'];$o=implode("\r\n",array("From:{$j}","Reply-To:{$j}","Return-Path:{$j}","Content-type:text/html;charset=\"UTF-8\"","Content-Transfer-Encoding:7bit","Date:".date('r',$n),"Message-ID:<$n".md5($n)."@{$_SERVER['SERVER_NAME']}>","MIME-Version:1.0",));$l='=?UTF-8?B?'.base64_encode(str_replace("\n",'',$l)).'?=';foreach((array)$k as$p){$_to=str_replace("\n",'',$p);$q[$_to]=mail($_to,$l,$m,$o);}return$q;}function filter($A,$g=null){static$r=array();if(is_callable($g)){$r[$A][]=$g;}else{$B=$g;if(empty($r[$A]))return$B;foreach($r[$A]as$i)$B=call_user_func($i,$B);return$B;}}function on($f,$g){event('on',$f,$g);}function off($f,$g=null){event('off',$f,$g);}function trigger($f){event('trigger',$f,array_slice(func_get_args(),1));}function triggerOnce($f){event('trigger',$f,array_slice(func_get_args(),1));event('off',$f,null);}function template($A,$d=array()){static$s=array();$t=rtrim(options('templates.dir')?:__DIR__.'/templates','/');$A=trim($A,'/');$u="$t/$A.html";if(!isset($s[$u])){$v=function($w){return '@$'.trim(str_replace('.','->',$w));};$x=array();$y='html';$z=preg_split('~({{|}}|{%|%}|{#|#}|{&|&})~m',file_get_contents($u),-1,2|1);foreach($z as$w){if($y=='skip'){if($w=='#}')$y='html';continue;}switch($w){case '{{':$y='echo';$x[]='<?=';break;case '}}':$y='html';$x[]='?>';break;case '{#':$y='skip';break;case '#}':$y='html';break;case '{%':$y='code';$x[]=' ';break;case '%}':$y='html';$x[]='?>';break;case '{&':$y='php';$x[]=' '."\n";break;case '&}':$y='html';$x[]="\n".'?>';break;default:switch($y){case 'skip':break;case 'code':$BA=array_filter(preg_split('~\s+~',$w));$BB=array_shift($BA);switch($BB){case 'for':if(strpos($BA[2],'..')!==false){$BC='range('.preg_replace('~\s*\.\.\s*~',',',$BA[2]).')';}else{$BC=$v($BA[2]);}$x[]='foreach('.$BC.'?:array()as$'.$BA[0].'){';break;case 'end':$x[]='}';break;}break;case 'echo':$y='html';$x[]=$v($w);break;case 'php':$x[]=trim($w);break;case 'html':$x[]=$w;break;}break;}}$s[$u]=implode('',$x);}$BD=$s[$u];return call_user_func(function()use($BD,$d){extract($d);return eval('?>'.$BD);});}register_shutdown_function(function(){route();$BE=response();foreach($BE['headers']as$B)header($B,true);echo$BE['body'];trigger('app.exit');});function get($BF,$g){route('get',$BF,$g);}function post($BF,$g){route('post',$BF,$g);}function put($BF,$g){route('put',$BF,$g);}function delete($BF,$g){route('delete',$BF,$g);}function route($a='@',$BF='',$g=null){static$BG=array();if($a=='@'){$BH=request();if(empty($BG[$BH['method']])){trigger(404);quit(404);}foreach($BG[$BH['method']]as$BI){if(preg_match('#^'.$BI['pattern'].'$#',$BH['uri'],$BJ)){array_shift($BJ);trigger('route.before',$BI,$BJ);response('start');$q=call_user_func_array($BI['callback'],$BJ);response('stop');if(is_array($q)||is_object($q)){response('delete');response('header','Content-Type','application/json');response('append',json_encode($q,32));}else{echo$q;}trigger('route.after',$BI);return;}trigger(404);quit(404);}}else{$a=strtolower(trim($a));if($BF)$BG[$a][]=array('pattern'=>preg_replace_callback('#(:\w+)#',function($Ba){return '([^/]+)';},str_replace('.','\.',$BF)),'callback'=>$g?:function(){},);}}